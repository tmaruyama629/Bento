<!--
@fileoverview ãŠå¼å½“æ³¨æ–‡ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIã§ã™ã€‚
@author T.Maruyama
@since 2025-05-08
@version 1.2.0

=================================================================================
 å¤‰æ›´å±¥æ­´
=================================================================================
2025-06-27 T.Maruyama v1.2.0
- [æ©Ÿèƒ½è¿½åŠ ] ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠæ™‚ã«å½“æ—¥ã¯é¸æŠä¸å¯ã¨ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¨­å®šã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ 

2025-06-27 T.Maruyama v1.1.6
- [ãƒã‚°ä¿®æ­£] ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã§ã‚‚ä¼‘æ—¥ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼/å·¥å ´ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³éæ´»æ€§ãƒ»æ³¨æ–‡ç™»éŒ²ä¸å¯ã¨ãªã‚‹ã‚ˆã†åˆ¤å®šå¼ã‚’ä¿®æ­£

2025-06-26 T.Maruyama v1.1.4
- [UIæ”¹å–„] ãƒ¢ãƒã‚¤ãƒ«ã¨PCç”¨ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã®åˆ†å²æ¡ä»¶ã‚’ç”»é¢å¹…ã‹ã‚‰any-hoverã«å¤‰æ›´

2025-06-26 T.Maruyama v1.1.3
- [UIæ”¹å–„] æ›œæ—¥è¡¨ç¤ºã‚’ã€ŒåœŸã€ã¯é’è‰²ã€ã€Œæ—¥ã€ã¯èµ¤è‰²ã§è¡¨ç¤ºï¼ˆPC/ãƒ¢ãƒã‚¤ãƒ«ä¸¡å¯¾å¿œï¼‰
- [UIæ”¹å–„] PCç‰ˆã¯å½“æ—¥ã®è¡Œå…¨ä½“ã€ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã¯å½“æ—¥ã®ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®èƒŒæ™¯è‰²ã‚’è–„ã„é»„è‰²ã«å¤‰æ›´

2025-06-25 T.Maruyama v1.1.2
- [æ”¹å–„] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ãƒ»ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼é€šçŸ¥UIæ”¹å–„

2025-06-24 T.Maruyama v1.1.1
- [UIæ”¹å–„] ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®åˆæœŸãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¤¾å“¡CDæ¬„ã«å¤‰æ›´

2025-06-23 T.Maruyama v1.1.0
- [æ©Ÿèƒ½å¤‰æ›´] ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã‚’ç¤¾å“¡CDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®çµ„ã¿åˆã‚ã›ã§è¡Œã†ã‚ˆã†ã«å¤‰æ›´
- [æ©Ÿèƒ½è¿½åŠ ] ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®å…¥åŠ›å€¤åˆ¶é™ï¼ˆç¤¾å“¡CD:åŠè§’æ•°å­—6æ¡, PW:åŠè§’è‹±æ•°è¨˜å·ï¼‰
- [æ©Ÿèƒ½è¿½åŠ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ã‚’è¿½åŠ 

2025-05-08 T.Maruyama v1.0.0
- æ–°è¦ä½œæˆ
=================================================================================
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <?!= HtmlService.createHtmlOutputFromFile('style').getContent(); ?>  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment-with-locales.min.js"></script>
</head>
<body>
  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ç”»é¢ -->
  <div id="login-container">
    <div class="login-form">
      <h1>ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </h1>
      <div class="form-group">
        <label for="employeeCD">ç¤¾å“¡CD</label>
        <input type="text" id="employeeCD" placeholder="åŠè§’æ•°å­—6æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6)" maxlength="6" />
      </div>
      <div class="form-group">
        <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <div class="password-wrapper">
          <input type="password" id="password" placeholder="åŠè§’ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚" onkeypress="handleLoginKeyPress(event)" oninput="this.value = this.value.replace(/[^ -~]/g, '')" />
          <span id="togglePassword" class="toggle-password-icon">ğŸ‘ï¸</span>
        </div>
      </div>
      <button onclick="checkPassword()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="error-message" class="error-message">èªè¨¼æƒ…å ±ãŒèª¤ã£ã¦ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ -->
  <div id="form-container" style="display: none;">
    <header id="page-header">
      <h1 id="form-title">ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </h1>
    </header>

    <div id="comment-area" style="margin-top: 20px;"></div>

    <label>ç¤¾å“¡:</label>
    <select id="employeeSelect">
      <option value="">ç¤¾å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
    </select>

    <br>

    <div class="bulk-set-container">
      <div class="bulk-set-item">
        <span class="bulk-label">ä¸€æ‹¬è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼:</span>
        <select id="bulkMenuSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="bulk-set-item">
        <span class="bulk-label">ä¸€æ‹¬è¨­å®šå·¥å ´:</span>
        <select id="bulkFactorySelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <button id="applyBulkChange">ä¸€æ‹¬è¨­å®š</button>
    </div>

    <div id="calendarContainer"></div>

    <br>

    <button id="submitOrder">æ³¨æ–‡ã‚’é€ä¿¡</button>
  </div>
  <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); z-index:9999; text-align:center; padding-top:20%;">
    <div class="spinner"></div>
    <div>å‡¦ç†ä¸­ã§ã™â€¦</div>
  </div>
  <script>

    window.addEventListener('DOMContentLoaded', function() {
      document.getElementById('employeeCD').focus();

      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('password');

      togglePassword.addEventListener('click', function () {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã®ã‚¿ã‚¤ãƒ—ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        // ã‚¢ã‚¤ã‚³ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
        this.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
      });
    });

    function onFailure(error) {
      console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
      let msg = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
      if (error && error.message) msg += "\n" + error.message;
      alert(msg);
      const errMsgDiv = document.getElementById("error-message");
      if (errMsgDiv) {
        errMsgDiv.textContent = msg;
        errMsgDiv.style.display = "block";
      }
      hideLoading && hideLoading();
    }

    function handleLoginKeyPress(event) {
      if (event.key === "Enter") {
        checkPassword();
      }
    }

    function checkPassword() {
      const empInput = document.getElementById('employeeCD');
      const pwInput = document.getElementById('password');
      if (!empInput || !pwInput) {
        alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ï¼šå…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      const emp = empInput.value;
      const pw = pwInput.value;
      // å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!emp || emp.length !== 6) {
        showError('ç¤¾å“¡CDã¯6æ¡ã®åŠè§’æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      if (!pw) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(result) {
        if (!result || result.status !== 'success') {
          showError(result && result.message ? result.message : 'èªè¨¼å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          return;
        }
        const data = result.data;
        if (data.isValid) {
          isAdmin = data.isAdmin;
          hideError();
          const loginContainer = document.getElementById("login-container");
          const formContainer = document.getElementById("form-container");
          if (loginContainer) loginContainer.style.display = "none";
          if (formContainer) formContainer.style.display = "block";
          if (!data.isAdmin) {
            const employeeSelect = document.getElementById("employeeSelect");
            if (employeeSelect) {
              employeeSelect.innerHTML = "";
              const option = document.createElement("option");
              option.value = data.employeeCD;
              option.textContent = `${data.employeeCD}_${data.employeeName}`;
              option.selected = true;
              employeeSelect.appendChild(option);
              employeeSelect.disabled = true;
            }
          }
          const formTitle = document.getElementById("form-title");
          if (formTitle) formTitle.textContent = isAdmin ? "ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ (ç®¡ç†è€…)" : "ãŠå¼å½“æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ ";
          drawCalendar(data.employeeCD);
        } else {
          showError('èªè¨¼æƒ…å ±ãŒèª¤ã£ã¦ã„ã¾ã™ã€‚');
        }
      }).verifyLogin(emp, pw);
    }

    function showError(msg) {
      const errMsgDiv = document.getElementById("error-message");
      if (errMsgDiv) {
        errMsgDiv.textContent = msg;
        errMsgDiv.style.display = "block";
      } else {
        alert(msg);
      }
    }
    function hideError() {
      const errMsgDiv = document.getElementById("error-message");
      if (errMsgDiv) errMsgDiv.style.display = "none";
    }

    function showLoading() {
      $('#loadingOverlay').show();
    }

    function hideLoading() {
      $('#loadingOverlay').hide();
    }

    function displayComments() {
      google.script.run.withFailureHandler(onFailure).withSuccessHandler(function (result) {
        if (!result || result.status !== 'success') {
          alert(result && result.message ? result.message : 'ãŠçŸ¥ã‚‰ã›ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          return;
        }
        const comments = result.data;
        const container = document.getElementById("comment-area");
        if (!container) return;
        container.innerHTML = "";
        const heading = document.createElement("h3");
        heading.textContent = "-ãŠçŸ¥ã‚‰ã›-";
        heading.style.marginBottom = "10px";
        heading.style.fontSize = "20px";
        heading.style.color = "#333";
        container.appendChild(heading);
        comments.forEach(comment => {
          const block = document.createElement("div");
          block.className = "comment-block";
          const para = document.createElement("p");
          if (comment.HyperLink) {
            const link = document.createElement("a");
            link.href = comment.HyperLink;
            link.textContent = comment.CommentText;
            link.target = "_blank";
            link.style.color = "#007bff";
            link.style.textDecoration = "underline";
            para.appendChild(link);
          } else {
            para.textContent = comment.CommentText;
          }
          block.appendChild(para);
          container.appendChild(block);
        });
      }).getComment();
    }

    window.onload = function () {
      displayComments();
    };

    let isAdmin = false;
    let factoryList = [];
    let defaultFactoryCD = '';
    const currentWeekStart = moment().startOf('week').add(1, 'days');

    function drawCalendar(emp) {
      showLoading();
      $('#calendarContainer').empty();
      // const isMobile = window.matchMedia("(max-width: 1200px)").matches;
      const isMobile = window.matchMedia("(any-hover: none)").matches;
      const weekList = [];
      for (let w = 0; w < 3; w++) {
        const start = moment(currentWeekStart).add(w, 'weeks');
        const end = moment(start).add(6, 'days');
        weekList.push({
          start,
          end,
          startStr: start.format('YYYY-MM-DD'),
          endStr: end.format('YYYY-MM-DD')
        });
      }
      weekList.sort((a, b) => a.start - b.start);
      let loadedCount = 0;
      const totalWeeks = weekList.length;
      weekList.forEach(({ start, end, startStr, endStr }) => {
        const weekDiv = $('<div class="week-container"></div>');
        let table;
        if (!isMobile) {
          weekDiv.append(`<h2 class="week-title">${startStr} ï½ ${endStr}</h2>`);
          table = $(`
            <table>
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>ç™»éŒ²æ¸ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                  <th>ç™»éŒ²æ¸ˆå·¥å ´</th>
                  <th>å¤‰æ›´å¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼</th>
                  <th>å¤‰æ›´å¾Œå·¥å ´</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          `);
          weekDiv.append(table);
        }

        $('#calendarContainer').append(weekDiv); // PC/ãƒ¢ãƒã‚¤ãƒ«å…±é€šã§é€±å˜ä½divã‚’è¿½åŠ 

        google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(result) {
          if (!result || result.status !== 'success') {
            alert(result && result.message ? result.message : 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            hideLoading();
            return;
          }
          const data = result.data;
          populateBulkSelectors(data.flatMap(d => d.Menus), factoryList);
          if (!isMobile) {
            const tbody = table.find('tbody');
            data.forEach(day => {
              const tr = $('<tr>').attr('data-factorycd', day.FactoryCD || '');
              const dateMoment = moment(day.Date);
              const isToday = dateMoment.isSame(moment(), 'day');
              const isPast = dateMoment.isBefore(moment(), 'day');
              // --- æ›œæ—¥è‰²åˆ†ã‘ ---
              const dow = dateMoment.format('ddd');
              let dowClass = '';
              if (dow === 'åœŸ') dowClass = 'weekday-sat';
              if (dow === 'æ—¥') dowClass = 'weekday-sun';
              const dateJP = dateMoment.format('MMæœˆDDæ—¥') + `ï¼ˆ<span class="${dowClass}">${dow}</span>ï¼‰`;
              // -----------------
              const dateCell = $(`<td>${dateJP}</td>`);
              if (isToday) {
                dateCell.addClass('today-cell');
                tr.addClass('today-row'); // â˜… è¡Œå…¨ä½“ã«èƒŒæ™¯è‰²
              }
              tr.append(dateCell);

              const before = day.Ordered ? `${day.MenuCD}_${day.MenuName}[${day.VenderName}]` : '-';
              tr.append(`<td>${before}</td>`);

              const factoryName = factoryList.find(f => f.FactoryCD === (day.FactoryCD || ''))?.FactoryName || '-';
              tr.append(`<td>${factoryName}</td>`); // ç™»éŒ²æ¸ˆå·¥å ´è¡¨ç¤º

              const tdNew = $('<td></td>');
              const tdFactory = $('<td></td>');

              if ((day.IsClosed) || !day.Menus.length || isPast) {
                const sel = $('<select disabled><option>å¤‰æ›´ä¸å¯</option></select>').attr('data-date', day.Date);
                const selFactory = $('<select class="factory-select" disabled><option>å¤‰æ›´ä¸å¯</option></select>').attr('data-date', day.Date);
                tdNew.append(sel);
                tdFactory.append(selFactory);
              } else {
                const sel = $('<select></select>').attr('data-date', day.Date);
                sel.append('<option value="NOCHANGE">å¤‰æ›´ãªã—</option>');
                day.Menus.forEach(m => {
                  const val = `${m.MenuCD}_${m.VenderCD}`;
                  const opt = $(`<option></option>`).val(val).text(`${m.MenuCD}_${m.MenuName}[${m.VenderName}]`);
                  if (day.RestrictedMenus && day.RestrictedMenus.includes(val)) {
                    opt.prop('disabled', true).text(`${m.MenuCD}_${m.MenuName}[${m.VenderName}]ï¼ˆé¸æŠä¸å¯ï¼‰`);
                  }
                  sel.append(opt);
                });
                tdNew.append(sel);

                const selFactory = $('<select class="factory-select"></select>').attr('data-date', day.Date);
                factoryList.forEach(fac => {
                  const opt = $('<option></option>').val(fac.FactoryCD).text(fac.FactoryName);
                  if (fac.FactoryCD === (day.FactoryCD || defaultFactoryCD)) opt.attr('selected', 'selected');
                  selFactory.append(opt);
                });
                tdFactory.append(selFactory);
              }

              tr.append(tdNew);
              tr.append(tdFactory);
              tbody.append(tr);
            });
          } else {
            // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º
            const groupedByWeek = {};
            data.forEach(day => {
              const weekKey = moment(day.Date).startOf('week').format('YYYY-MM-DD');
              if (!groupedByWeek[weekKey]) groupedByWeek[weekKey] = [];
              groupedByWeek[weekKey].push(day);
            });

            const sortedWeeks = Object.keys(groupedByWeek).sort((a, b) => moment(a).toDate() - moment(b).toDate());

            sortedWeeks.forEach(weekKey => {
              const days = groupedByWeek[weekKey].sort((a, b) => moment(a.Date).toDate() - moment(b.Date).toDate());
              days.forEach(day => {
                // --- æ›œæ—¥è‰²åˆ†ã‘ ---
                const dateMoment = moment(day.Date);
                const isToday = dateMoment.isSame(moment(), 'day');
                const isPast = dateMoment.isBefore(moment(), 'day');
                const dow = dateMoment.format('ddd');
                let dowClass = '';
                if (dow === 'åœŸ') dowClass = 'weekday-sat';
                if (dow === 'æ—¥') dowClass = 'weekday-sun';
                const dateJP = dateMoment.format('MMæœˆDDæ—¥') + `ï¼ˆ<span class="${dowClass}">${dow}</span>ï¼‰`;
                // -----------------
                const entry = $('<div class="mobile-entry"></div>').attr('data-factorycd', day.FactoryCD || '');
                if (isToday) entry.addClass('today-card'); // â˜… å½“æ—¥ã‚«ãƒ¼ãƒ‰èƒŒæ™¯è‰²
                entry.append(`<div class="date"><strong>${dateJP}</strong>${isToday ? '<span class="today">ï¼ˆæœ¬æ—¥ï¼‰</span>' : ''}</div>`);

                const before = day.Ordered ? `${day.MenuCD}_${day.MenuName}[${day.VenderName}]` : '-';
                const factoryName = factoryList.find(f => f.FactoryCD === (day.FactoryCD || ''))?.FactoryName || '-';

                const beforeDiv = $('<div class="value"></div>').text(before);
                beforeDiv.attr('data-menucd', day.MenuCD || '');
                beforeDiv.attr('data-vendercd', day.VenderCD || '');
                entry.append(`<div class="row"><div class="label">ç™»éŒ²æ¸ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼š</div></div>`).find('.row:last').append(beforeDiv);

                entry.append(`
                  <div class="row">
                    <div class="label">ç™»éŒ²æ¸ˆå·¥å ´ï¼š</div>
                    <div class="value">${factoryName}</div>
                  </div>
                `);

                const sel = $('<select></select>').attr('data-date', day.Date);
                if ((day.IsClosed) || !day.Menus.length || isPast) {
                  sel.prop('disabled', true).append('<option>å¤‰æ›´ä¸å¯</option>');
                } else {
                  sel.append('<option value="NOCHANGE">å¤‰æ›´ãªã—</option>');
                  day.Menus.forEach(m => {
                    const val = `${m.MenuCD}_${m.VenderCD}`;
                    const opt = $(`<option></option>`).val(val).text(`${m.MenuCD}_${m.MenuName}[${m.VenderName}]`);
                    if (day.RestrictedMenus && day.RestrictedMenus.includes(val)) {
                      opt.prop('disabled', true).text(`${m.MenuCD}_${m.MenuName}[${m.VenderName}]ï¼ˆé¸æŠä¸å¯ï¼‰`);
                    }
                    sel.append(opt);
                  });
                }
                entry.append(`
                  <div class="row">
                    <div class="label">å¤‰æ›´å¾Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼š</div>
                  </div>
                `).find('.row:last').append(sel);

                const selFactory = $('<select class="factory-select"></select>').attr('data-date', day.Date);
                if ((day.IsClosed) || !day.Menus.length || isPast) {
                  selFactory.prop('disabled', true).append('<option>å¤‰æ›´ä¸å¯</option>');
                } else {
                  factoryList.forEach(fac => {
                    const opt = $('<option></option>').val(fac.FactoryCD).text(fac.FactoryName);
                    if (fac.FactoryCD === (day.FactoryCD || defaultFactoryCD)) opt.attr('selected', 'selected');
                    selFactory.append(opt);
                  });
                }
                entry.append(`
                  <div class="row">
                    <div class="label">å¤‰æ›´å¾Œå·¥å ´ï¼š</div>
                  </div>
                `).find('.row:last').append(selFactory);

                // ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šweekDiv ã« entry ã‚’è¿½åŠ 
                weekDiv.append(entry);
              });
            });
          }
          loadedCount++; // â˜… 1é€±åˆ†ã®å‡¦ç†ãŒå®Œäº†
          if (loadedCount === totalWeeks) {
            hideLoading(); // â˜… å…¨ã¦ã®é€±ã®æç”»ãŒå®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
          }
        }).getMenuForWeek(emp, startStr, endStr, isAdmin);
      });
    }

    // ä¸€æ‹¬è¨­å®šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    function populateBulkSelectors(menuList, factoryList) {
      const menuSelect = document.getElementById("bulkMenuSelect");
      const factorySelect = document.getElementById("bulkFactorySelect");

      // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
      menuSelect.innerHTML = "";
      factorySelect.innerHTML = "";

      // é‡è¤‡ã‚’æ’é™¤ã™ã‚‹ãŸã‚ã®Setã‚’ä½¿ç”¨
      const seenMenuCombo = new Set();

      menuList.forEach(menu => {
        const menuCombo = `${menu.MenuCD}_${menu.VenderCD}`;

        // ã™ã§ã«é¸æŠè‚¢ã«è¿½åŠ æ¸ˆã¿ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if (!seenMenuCombo.has(menuCombo)) {
          const option = document.createElement("option");
          option.value = menuCombo;
          option.textContent = `${menu.MenuCD}_${menu.MenuName}[${menu.VenderName}]`;
          menuSelect.appendChild(option);

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼çµ„ã¿åˆã‚ã›ã‚’ã‚»ãƒƒãƒˆã«è¿½åŠ 
          seenMenuCombo.add(menuCombo);
        }
      });

      // å·¥å ´é¸æŠè‚¢ã®è¿½åŠ ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼‰
      factoryList.forEach(factory => {
        const option = document.createElement("option");
        option.value = factory.FactoryCD;
        option.textContent = factory.FactoryName;
        factorySelect.appendChild(option);
      });

      // è©²å½“ç¤¾å“¡ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå·¥å ´ã‚’è¨­å®š
      if (defaultFactoryCD) {
        const defaultFactoryOption = factorySelect.querySelector(`option[value="${defaultFactoryCD}"]`);
        if (defaultFactoryOption) {
          defaultFactoryOption.selected = true; // è©²å½“ã™ã‚‹å·¥å ´ã‚’é¸æŠçŠ¶æ…‹ã«
        }
      }
    }

    $(function () {
      moment.locale('ja');
  
      google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(result) {
        if (!result || result.status !== 'success') {
          alert(result && result.message ? result.message : 'ç¤¾å“¡ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          return;
        }
        result.data.forEach(emp => {
          $('#employeeSelect').append(new Option(
            `${emp.EmployeeCD}_${emp.EmployeeName}`,
            emp.EmployeeCD
          ));
        });
      }).getEmployeeList();
  
      google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(result) {
        if (!result || result.status !== 'success') {
          alert(result && result.message ? result.message : 'å·¥å ´ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          return;
        }
        factoryList = result.data;
      }).getFactoryList();
  
      $('#employeeSelect').change(function () {
        const emp = $(this).val();
        if (!emp) {
          $('#calendarContainer').empty();
          return;
        }
  
        google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(res) {
          if (!res || res.status !== 'success') {
            alert(res && res.message ? res.message : 'ç¤¾å“¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
          }
          defaultFactoryCD = res.data.defaultFactory;
          drawCalendar(emp);
        }).getEmployeeData(emp);
      });

      $('#applyBulkChange').click(function () {
        const selectedMenu = $('#bulkMenuSelect').val();
        const selectedFactory = $('#bulkFactorySelect').val();
        // const isMobile = window.matchMedia("(max-width: 1200px)").matches;
        const isMobile = window.matchMedia("(any-hover: none)").matches;

        // console.log("é¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼:", selectedMenu);
        // console.log("é¸æŠå·¥å ´:", selectedFactory);

        if (!selectedMenu && !selectedFactory) {
          alert('ä¸€æ‹¬ã§é©ç”¨ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¾ãŸã¯å·¥å ´ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }

        const targetRows = isMobile ? $('.mobile-entry') : $('#calendarContainer tbody tr');

        targetRows.each(function () {
          const row = $(this);
          const menuSel = row.find('select[data-date]');
          const factorySel = row.find('select.factory-select');

          const dateStr = menuSel.data('date'); // "YYYY-MM-DD" å½¢å¼ã§å–å¾—ã•ã‚Œã‚‹æƒ³å®š
          const date = new Date(dateStr);
          const day = date.getDay(); // 0:æ—¥æ›œ, 6:åœŸæ›œ

          // â˜… åœŸæ—¥ã‚’ã‚¹ã‚­ãƒƒãƒ—
          if (day === 0 || day === 6) {
            console.log("ã‚¹ã‚­ãƒƒãƒ—ï¼ˆåœŸæ—¥ï¼‰:", dateStr);
            return; // å‡¦ç†ã‚’é£›ã°ã™
          }

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå½“æ—¥ã®é¸æŠè‚¢ã«å­˜åœ¨ã—ãªã„å ´åˆã€ã‚¹ã‚­ãƒƒãƒ—
          const availableMenuOptions = menuSel.find('option').map(function() {
            return $(this).val();
          }).get();

          if (selectedMenu && !availableMenuOptions.includes(selectedMenu)) {
            console.log("ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé¸æŠè‚¢ã«å­˜åœ¨ã—ãªã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰:", dateStr);
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¤‰æ›´ã—ãªã„
            return; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤‰æ›´ãªã—
          }

          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒå¤‰æ›´å¯èƒ½ãªå ´åˆ
          if (!menuSel.prop('disabled') && selectedMenu) {
            menuSel.val(selectedMenu).trigger('change');
          }

          // å·¥å ´ãŒå¤‰æ›´å¯èƒ½ãªå ´åˆ
          if (!factorySel.prop('disabled') && selectedFactory) {
             factorySel.val(selectedFactory).trigger('change');
          }
        });
      });
  
      $('#submitOrder').click(function () {
        showLoading(); // â˜… å‡¦ç†ä¸­è¡¨ç¤º

        const emp = $('#employeeSelect').val();
        if (!emp) {
          alert('ç¤¾å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
          hideLoading(); // â˜… é¸æŠã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã¯éè¡¨ç¤º
          return;
        }
  
        const now = moment().format('YYYYMMDDHHmmss');
        const selections = [];
        // const isMobile = window.matchMedia("(max-width: 1200px)").matches;
        const isMobile = window.matchMedia("(any-hover: none)").matches;
        const targetRows = isMobile ? $('.mobile-entry') : $('#calendarContainer tbody tr');
  
        targetRows.each(function () {
          const row = $(this);
          const menuSel = row.find('select[data-date]');
          const factorySel = row.find('select.factory-select');
          const date = menuSel.data('date');
          const menuVal = menuSel.val();
          const factoryVal = factorySel.val();

            // âš  select ãŒ disabled ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆéå»æ—¥ãªã©ï¼‰
            if (menuSel.prop('disabled') && factorySel.prop('disabled')) {
              return;
            }
  
          let oldMenuCD = '';
          let oldVenderCD = '';
          let beforeFactoryCD = '';
  
          if (isMobile) {
            const beforeMenuDiv = row.find('.row').eq(0).find('.value');
            oldMenuCD = beforeMenuDiv.attr('data-menucd') || '';
            oldVenderCD = beforeMenuDiv.attr('data-vendercd') || '';
            beforeFactoryCD = row.attr('data-factorycd') || '';
          } else {
            const beforeMenuText = row.find('td:nth-child(2)').text();
            const m = beforeMenuText.match(/^(\d+)_.*\[.*\]$/);
            if (m) oldMenuCD = m[1];
            beforeFactoryCD = row.attr('data-factorycd') || '';
          }
  
          let newMenuCD = '';
          let newVenderCD = '';
          if (menuVal && menuVal !== 'NOCHANGE') {
            [newMenuCD, newVenderCD] = menuVal.split('_');
          }

          const isMenuChanged = menuVal !== 'NOCHANGE' && (newMenuCD !== oldMenuCD || newVenderCD !== oldVenderCD);
          const isFactoryChanged = factoryVal !== '' && factoryVal !== beforeFactoryCD;

          if (isMenuChanged || isFactoryChanged) {
            selections.push({
              OrderDate: moment(date).format('YYYYMMDD'),
              EmployeeCD: emp,
              FactoryCD: factoryVal || '',
              MenuCD: newMenuCD || '',
              VenderCD: newVenderCD || '',
              ActiveFlg: 1,
              UpdateDate: now
            });
          }
        });

         // console.log(selections);ã€€// ãƒ‡ãƒãƒƒã‚°ç”¨

        if (selections.length === 0) {
          alert('å¤‰æ›´ã•ã‚ŒãŸæ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
          hideLoading(); // â˜… å‡¦ç†ãªã—ã®ã¨ãã‚‚éè¡¨ç¤º
          return;
        }

        google.script.run.withFailureHandler(onFailure).withSuccessHandler(function(result) {
          hideLoading(); // â˜… æˆåŠŸæ™‚ã«éè¡¨ç¤º
          if (!result || result.status !== 'success') {
            alert(result && result.message ? result.message : 'æ³¨æ–‡ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            return;
          }
          const inserted = result.data;
          if (inserted.length === 0) {
            alert("å¤‰æ›´ã•ã‚ŒãŸæ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
          } else {
            const msg = inserted.map(o => {
              const date = new Date(o.OrderDate);
              const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
              const menuDisplay = `${o.MenuCD}_${o.MenuName}[${o.VenderName}]`;
              const factoryName = factoryList.find(f => f.FactoryCD === o.FactoryCD)?.FactoryName || 'ä¸æ˜ãªå·¥å ´'; // FactoryCDã‹ã‚‰FactoryNameã‚’å–å¾—
              const month = (date.getMonth() + 1).toString().padStart(2, '0'); // æœˆã‚’2æ¡è¡¨ç¤º
              const day = date.getDate().toString().padStart(2, '0'); // æ—¥ã‚’2æ¡è¡¨ç¤º
              return `${month}æœˆ${day}æ—¥(${dayOfWeek})ï¼š${menuDisplay} @ ${factoryName}`;
            }).join('\n');
            alert(`æ³¨æ–‡ã‚’${inserted.length}ä»¶ç™»éŒ²ã—ã¾ã—ãŸï¼š\n` + msg);
          }
          drawCalendar(emp); // â˜… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†èª­ã¿è¾¼ã¿
        }).saveOrderData(emp, selections, isAdmin);
      });
    });
  </script>  
</body>

</html>
